<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>âœ¨MagicPaletteAnalyzer - ç”»åƒã‹ã‚‰è‰²ã‚’å¬å–šã™ã‚‹é­”å°å…· ver 0.0.1</title>
  <meta name="viewport" content="initial-scale=1.0,maximum-scale=1,width=device-width,viewport-fit=cover">
  <meta name="description"
    content="MagicPaletteAnalyzer - ç”»åƒã«å®¿ã‚‹è‰²ã®ç²¾éœŠã‚’å¯è¦–åŒ–ã™ã‚‹ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆãƒ„ãƒ¼ãƒ«ã€‚ç³ã®è‰²ã‹ã‚‰é¢¨æ™¯ã¾ã§ã€ã‚ã‚‰ã‚†ã‚‹ç”»åƒã‚’16è‰²ã®é­”æ–¹é™£ã¸å¤‰æ›ã€‚è¡“å¸«ã®ãŸã‚ã®è‰²å½©éŒ¬é‡‘è¡“ãƒ„ãƒ¼ãƒ«ã€‚">
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <!-- Tailwind CSS CDNï¼ˆç°¡æ˜“çš„ãªåˆ©ç”¨ä¾‹ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta property="og:url" content="https://haruharu-1105.github.io/MagicPaletteAnalyzer/">
  <meta property="og:type" content="website">
  <meta property="og:title" content="MagicPaletteAnalyzer">
  <meta property="og:description" content="ç”»åƒã«æ½œã‚€è‰²ã®ç²¾éœŠã‚’16è‰²ã®é­”æ³•é™£ã«å°ã˜è¾¼ã‚ã€‚ç³ã®è¼ãã‹ã‚‰é¢¨æ™¯ã®æ¯å¹ã¾ã§ã€ã‚ã‚‰ã‚†ã‚‹ç”»åƒã‚’è‰²å½©éŒ¬é‡‘è¡“ã§å†æ§‹ç¯‰ã€‚è¡“å¸«ã®ãŸã‚ã®ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆå„€å¼ã€‚">
  <meta name="google" content="notranslate">
</head>

<body>

  <body class="bg-gray-100 mx-4 w-full">
    <!-- å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="fixed top-0 left-0 w-full bg-white shadow z-50">
      <h1 class="m-0 text-2xl font-bold px-4 py-4">âœ¨MagicPalette Analyzer ver 0.0.1</h1>
      <!-- ä½¿ç”¨æ–¹æ³•ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="ml-4">
        <details class="border border-gray-300 px-4 py-4 rounded bg-white">
          <summary class="text-lg font-semibold cursor-pointer">ä½¿ç”¨æ–¹æ³•</summary>
          <div class="mt-2 text-gray-700">
            <p>1. ç”»åƒã®èª­ã¿è¾¼ã¿</p>
            <ul class="list-disc list-inside ml-4">
              <li>a,ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ç”»åƒã‚’é¸æŠã—ã¾ã™ã€‚</li>
              <li>b,ã€Œã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚</li>
              <li>c, ç”»åƒã‚’ã‚³ãƒ”ãƒ¼ã—ãŸçŠ¶æ…‹ã§ã€Œã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</li>
            </ul>
            <p>2. ãƒ‘ãƒ¬ãƒƒãƒˆã®å†…å®¹ç¢ºèªï¼š</p>
            <ul class="list-disc list-inside ml-4">
              <li>ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã«åˆ†æã•ã‚ŒãŸè‰²ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
              <li>ã‚«ãƒ©ãƒ¼ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã§é¸æŠã—ãŸè‰²ã®å±¥æ­´ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
            </ul>
          </div>
        </details>
      </div>
    </header>
    <!-- ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="flex pt-24">
      <!-- å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå›ºå®šï¼‰ -->
      <aside class="fixed left-0 top-32 w-40 h-full bg-white shadow">
        <!-- ç¾åœ¨é¸æŠè‰²è¡¨ç¤º -->
        <h2 class="text-xl font-bold m-4">ç¾åœ¨é¸æŠè‰²</h2>
        <div id="color-info" class="flex flex-col items-center">
          <div id="color-display" class="w-20 h-20 border border-black mb-4"></div>
          <div class="text-sm">
            <div>HEX: <span id="color-hex">#FFFFFF</span></div>
            <div>RGB: <span id="color-rgb">255, 255, 255</span></div>
            <div>HSV: <span id="color-hsv">0, 0, 100</span></div>
          </div>
        </div>
      </aside>
      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <main class="flex-1 ml-40">
        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã®ä½™ç™½ã‚’ç¢ºä¿ï¼‰ -->
        <div id="container" class="font-sans flex flex-col gap-2 my-8 max-w-full">
          <div id="image-container" class="border-2 border-dashed border-gray-300 " height="320px">
            <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
            <div id="canvas-area" class="mb-4">
              <canvas id="image-canvas" height="320px"></canvas>
            </div>
            <div class="flex items-center gap-3 mb-4">
              <input type="file" id="file-input" accept="image/*" class="p-2 border border-gray-300 py-2 rounded">
              <button id="paste-button"
                class="px-16 bg-orange-500 text-white rounded hover:bg-orange-600 text-nowrap h-12">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ğŸ“‹
              </button>
              <div id="drop-area" class="w-full py-2.5 border-b-2 border-gray-400 bg-gray-50 text-center font-bold">
                ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
              </div>
            </div>
          </div>

          <hr>

          <!-- ç”»åƒã®ãƒ‘ãƒ¬ãƒƒãƒˆè¡¨ç¤º -->
          <div id="palette" class="border border-gray-300 p-2.5">
            <h3 class="text-lg font-semibold">ğŸ¨ç”»åƒã®ãƒ‘ãƒ¬ãƒƒãƒˆ</h3>
            <div id="palette-colors" class="grid gap-1 mt-2"
              style="grid-template-columns: repeat(16, 40px); grid-template-rows: repeat(4, 40px);">
            </div>

            <!-- ã‚«ãƒ©ãƒ¼ãƒ’ã‚¹ãƒˆãƒªãƒ¼è¡¨ç¤º -->
            <div id="history" class="border border-gray-300 p-2.5 mt-4">
              <!-- ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’åŒã˜è¡Œã«é…ç½® -->
              <div class="flex items-center">
                <h3 class="text-lg font-semibold px-4">ã‚«ãƒ©ãƒ¼ãƒ’ã‚¹ãƒˆãƒªãƒ¼</h3>
                <button id="download-history"
                  class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                  disabled>
                  ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â¬‡
                </button>
              </div>
              <!-- ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã®è‰²ãƒœãƒƒã‚¯ã‚¹ã‚’æœ€å¤§16åˆ—ã§è¡¨ç¤º -->
              <div id="history-colors" class="grid gap-1 mt-2" style="grid-template-columns: repeat(16, 64px);">
                <!-- ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã®è‰²ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
              </div>
              <!-- ã‚«ãƒ©ãƒ¼ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
              <div class="mt-4">
                <h3 class="text-lg font-semibold">ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                <div>
                  <input type="radio" id="history-include-image" name="history-download-option" value="include"
                    class="mr-2" checked>
                  <label for="history-include-image">å…ƒç”»åƒã®ä¸‹ã«ãƒ’ã‚¹ãƒˆãƒªãƒ¼æƒ…å ±ã‚’è¿½åŠ ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</label>
                </div>
                <div>
                  <input type="radio" id="history-only" name="history-download-option" value="history-only"
                    class="mr-2">
                  <label for="history-only">ãƒ’ã‚¹ãƒˆãƒªãƒ¼æƒ…å ±ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</label>
                </div>
              </div>
            </div>
            <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="mt-4">
              <h3 class="text-lg font-semibold">ãƒ‘ãƒ¬ãƒƒãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
              <div>
                <input type="radio" id="include-image" name="download-option" value="include" class="mr-2" checked>
                <label for="include-image">å…ƒç”»åƒã®ä¸‹ã«ãƒ‘ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’è¿½åŠ ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</label>
              </div>
              <div>
                <input type="radio" id="palette-only" name="download-option" value="palette-only" class="mr-2">
                <label for="palette-only">ãƒ‘ãƒ¬ãƒƒãƒˆæƒ…å ±ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</label>
              </div>
              <button id="download-palette"
                class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600  disabled:bg-gray-300 disabled:cursor-not-allowed"
                disabled>
                ãƒ‘ãƒ¬ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â¬‡
              </button>
            </div>
            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="error-message"
              class="fixed bottom-0 left-0 w-full bg-white p-2.5 text-center text-red-500 border-t border-gray-300">
            </div>

            <!-- ä¸€ç•ªä¸Šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
            <button id="back-to-top"
              class="fixed bottom-8 right-8 bg-blue-500 text-white px-4 py-2 rounded shadow-lg hidden hover:bg-blue-600">
              ä¸€ç•ªä¸Šã«æˆ»ã‚‹
            </button>
      </main>
    </div>
    </div>

    <script>
      // ------------------------------------------------
      // ColorHelper ã‚¯ãƒ©ã‚¹ï¼ˆè‰²å¤‰æ›ãƒ»æƒ…å ±å–å¾—ç”¨ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ï¼‰
      // ------------------------------------------------
      class ColorHelper {
        /**
        * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿  
        * input: æ–‡å­—åˆ—ï¼ˆ"#RRGGBB"å½¢å¼ãªã©ï¼‰ã¾ãŸã¯ {r, g, b} ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        */
        constructor(input) {
          if (typeof input === 'string') {
            this.rgb = ColorHelper.hexToRgb(input);
          } else if (typeof input === 'object' && input.r !== undefined) {
            this.rgb = { r: input.r, g: input.g, b: input.b };
          } else {
            throw new Error("Invalid color input");
          }
        }

        /**
        * 16é€²æ•°æ–‡å­—åˆ—ã‹ã‚‰ RGB ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸å¤‰æ›ã™ã‚‹é™çš„ãƒ¡ã‚½ãƒƒãƒ‰
        * @param {string} hex - "#RRGGBB" å½¢å¼ã®æ–‡å­—åˆ—
        * @returns {object} {r, g, b}
        */
        static hexToRgb(hex) {
          hex = hex.replace('#', '');
          if (hex.length === 3) {
            hex = hex.split('').map(ch => ch + ch).join('');
          }
          const bigint = parseInt(hex, 16);
          const r = (bigint >> 16) & 255;
          const g = (bigint >> 8) & 255;
          const b = bigint & 255;
          return { r, g, b };
        }

        /**
        * RGBã‹ã‚‰16é€²æ•°è¡¨è¨˜ã«å¤‰æ›ã™ã‚‹é™çš„ãƒ¡ã‚½ãƒƒãƒ‰
        * @param {number} r 
        * @param {number} g 
        * @param {number} b 
        * @returns {string} "#RRGGBB" å½¢å¼ã®æ–‡å­—åˆ—
        */
        static rgbToHex(r, g, b) {
          return "#" + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
        }

        /**
        * ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® RGB å€¤ã‹ã‚‰ 16é€²æ•°è¡¨è¨˜ã«å¤‰æ›ã™ã‚‹
        * @returns {string} "#RRGGBB" å½¢å¼ã®æ–‡å­—åˆ—
        */
        toHex() {
          return ColorHelper.rgbToHex(this.rgb.r, this.rgb.g, this.rgb.b);
        }

        /**
        * RGBå€¤ã‹ã‚‰ HSV å€¤ã¸å¤‰æ›ã™ã‚‹é™çš„ãƒ¡ã‚½ãƒƒãƒ‰  
        * @param {number} r 
        * @param {number} g 
        * @param {number} b 
        * @returns {Array} [h, s, v]ï¼ˆh: 0ï½360, s,v: 0ï½100ï¼‰
        */
        static rgbToHsv(r, g, b) {
          r /= 255; g /= 255; b /= 255;
          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          let h, s, v = max;
          const d = max - min;
          s = max === 0 ? 0 : d / max;
          if (max === min) {
            h = 0;
          } else {
            switch (max) {
              case r: h = (g - b) / d + (g < b ? 6 : 0); break;
              case g: h = (b - r) / d + 2; break;
              case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
          }
          return [Math.round(h * 360), Math.round(s * 100), Math.round(v * 100)];
        }

        /**
        * ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® RGB å€¤ã‹ã‚‰ HSV å€¤ã¸å¤‰æ›ã™ã‚‹
        * @returns {Array} [h, s, v]ï¼ˆh: 0ï½360, s,v: 0ï½100ï¼‰
        */
        toHsv() {
          return ColorHelper.rgbToHsv(this.rgb.r, this.rgb.g, this.rgb.b);
        }
        /**
        * ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® RGB å€¤ã‹ã‚‰ RGB ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸å¤‰æ›ã™ã‚‹
        * @returns {Array} [r, g, b]
        */
        toRGB() {
          return [this.rgb.r, this.rgb.g, this.rgb.b];
        }

        /**
        * ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ï¼šRGBå€¤ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
        * @param {number} r
        * @param {number} g
        * @param {number} b
        * @returns {ColorHelper}
        */
        static fromRgb(r, g, b) {
          return new ColorHelper({ r, g, b });
        }

      }
      // å„è¦ç´ ã®å–å¾—
      const fileInput = document.getElementById('file-input');
      const dropArea = document.getElementById('drop-area');
      const canvas = document.getElementById('image-canvas');
      const ctx = canvas.getContext('2d', {
        willReadFrequently: true
      });
      const pasteButton = document.getElementById('paste-button');
      const paletteContainer = document.getElementById('palette-colors');
      const currentColorDisplay = document.getElementById('color-display');
      const historyContainer = document.getElementById('history-colors');
      const errorMessage = document.getElementById('error-message');
      const backToTopBtn = document.getElementById('back-to-top');
      const downloadPaletteBtn = document.getElementById('download-palette');
      let lastColor = null;
      const downloadHistoryBtn = document.getElementById('download-history');
      const colorHex = document.getElementById('color-hex');
      const colorRgb = document.getElementById('color-rgb');
      const colorHsv = document.getElementById('color-hsv');

      /** ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼š16é€²æ•°ã‹ã‚‰ç¾åœ¨è‰²è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
      * @param {string} hex
      */
      function updateCurrentColor(hex) {
        currentColorDisplay.style.background = hex;
        colorHex.textContent = hex;
        const currentColor = new ColorHelper(hex);
        const [r, g, b] = currentColor.toRGB();
        colorRgb.textContent = `${r}, ${g}, ${b}`;
        const [h, s, v] = currentColor.toHsv();
        colorHsv.textContent = `${h}, ${s}, ${v}`;
      }

      let img = new Image();

      // ç”»åƒèª­ã¿è¾¼ã¿å‡¦ç†
      function loadImage(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          img = new Image();
          img.onload = function () {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            analyzeColors();
          }
          img.src = e.target.result;
        }
        reader.readAsDataURL(file);
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
      fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          loadImage(e.target.files[0]);
        }
      });

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ç”»åƒã‚’èª­ã¿è¾¼ã‚€å‡¦ç†
      async function handlePasteButtonClick() {
        try {
          const clipboardItems = await navigator.clipboard.read();
          for (const item of clipboardItems) {
            for (const type of item.types) {
              if (type.startsWith('image/')) {
                const blob = await item.getType(type);
                loadImage(blob);
                return;
              }
            }
          }
          alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“");
        } catch (error) {
          console.error("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®ç”»åƒå–å¾—ã«å¤±æ•—:", error);
          alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®ç”»åƒã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      }
      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      pasteButton.addEventListener('click', handlePasteButtonClick);

      // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®å‡¦ç†
      dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.style.background = "#eee";
      });
      dropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropArea.style.background = "";
      });
      dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.style.background = "";
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          loadImage(e.dataTransfer.files[0]);
        }
      });

      // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆè§£æ
      function analyzeColors() {
        // ç”»åƒã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—
        const width = canvas.width;
        const height = canvas.height;
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        const colorCount = {};

        // å…¨ãƒ”ã‚¯ã‚»ãƒ«ã‚’å¯¾è±¡ã«ã™ã‚‹ã¨é‡ã„ã®ã§ã€ä¸€å®šé–“éš”ï¼ˆä¾‹: 10pxï¼‰ã§ã‚µãƒ³ãƒ—ãƒ«
        const step = 10;
        for (let y = 0; y < height; y += step) {
          for (let x = 0; x < width; x += step) {
            const index = (y * width + x) * 4;
            const r = data[index];
            const g = data[index + 1];
            const b = data[index + 2];
            // é€æ˜åº¦ãŒä½ã„ã‚‚ã®ã¯é™¤å¤–ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
            const a = data[index + 3];
            if (a < 128) continue;
            // ç°¡æ˜“é‡å­åŒ–ï¼šå„ãƒãƒ£ãƒ³ãƒãƒ«ã‚’16æ®µéšã«ä¸¸ã‚ã‚‹
            const key = [
              Math.floor(r / 16) * 16,
              Math.floor(g / 16) * 16,
              Math.floor(b / 16) * 16
            ].join(',');
            colorCount[key] = (colorCount[key] || 0) + 1;
          }
        }

        // å‡ºç¾é »åº¦ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã€ä¸Šä½64è‰²ã‚’æŠ½å‡º
        const sortedColors = Object.entries(colorCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 64);

        // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¯ãƒªã‚¢
        paletteContainer.innerHTML = "";
        // ã‚«ãƒ©ãƒ¼ãƒ’ã‚¹ãƒˆãƒªãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¯ãƒªã‚¢
        historyContainer.innerHTML = "";
        // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆãŒç©ºã«ãªã£ãŸã®ã§ç„¡åŠ¹åŒ–
        downloadPaletteBtn.disabled = true;
        // ãƒ’ã‚¹ãƒˆãƒªãƒ¼ãŒç©ºã«ãªã£ãŸã®ã§ç„¡åŠ¹åŒ–
        downloadHistoryBtn.disabled = true;

        // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆè¡¨ç¤ºï¼ˆæ¨ª16å€‹Ã—ç¸¦4å€‹ã®ã‚°ãƒªãƒƒãƒ‰ï¼‰
        sortedColors.forEach(([colorKey, count]) => {
          const [r, g, b] = colorKey.split(',').map(Number);
          const hex = ColorHelper.rgbToHex(r, g, b);
          const colorDiv = document.createElement('div');
          colorDiv.className = 'color-box';
          colorDiv.style.background = hex;
          colorDiv.title = `${hex} (${count}å›)`;
          colorDiv.textContent = "";

          colorDiv.addEventListener('click', () => {
            updateCurrentColor(hex);
            addColorToHistory(hex);
          });
          paletteContainer.appendChild(colorDiv);
        });

        downloadPaletteBtn.disabled = paletteContainer.length > 0;
      }

      // ãƒã‚¦ã‚¹ç§»å‹•æ™‚ã«ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®è‰²ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = Math.floor((e.clientX - rect.left) * scaleX);
        const y = Math.floor((e.clientY - rect.top) * scaleY);
        const pixel = ctx.getImageData(x, y, 1, 1).data;
        const [r, g, b, a] = pixel;
        if (a === 0) return;  // é€æ˜ãªå ´åˆã¯ç„¡è¦–
        const hex = ColorHelper.rgbToHex(r, g, b);
        updateCurrentColor(hex)
      });

      // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«è‰²ã‚’ã‚«ãƒ©ãƒ¼ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã«è¿½åŠ 
      canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = Math.floor((e.clientX - rect.left) * scaleX);
        const y = Math.floor((e.clientY - rect.top) * scaleY);
        const pixel = ctx.getImageData(x, y, 1, 1).data;
        const [r, g, b, a] = pixel;
        if (a === 0) return;
        const hex = ColorHelper.rgbToHex(r, g, b);
        addColorToHistory(hex);
      });
      /** æ˜åº¦åˆ¤å®šã®ãŸã‚ã®é–¢æ•°ï¼ˆè¼åº¦è¨ˆç®—ï¼‰
      * @param {string} hex
      */
      function isDarkColor(hex) {
        // hex ãŒ "#RRGGBB" å½¢å¼ã®å ´åˆ
        const { r, g, b } = ColorHelper.hexToRgb(hex)
        // è¼åº¦ã®è¨ˆç®—ï¼ˆITU-R BT.601 ä¿‚æ•°ã‚’åˆ©ç”¨ï¼‰
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128; // è¼åº¦ãŒä½ã‘ã‚Œã°æš—ã„ã¨åˆ¤æ–­
      }
      /** ã‚«ãƒ©ãƒ¼ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã«è‰²ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
      * @param {string} hex
      */
      function addColorToHistory(hex) {
        if (hex === lastColor) {
          errorMessage.textContent = "ç›´å‰ã®è‰²ã¨åŒã˜ãŸã‚è¿½åŠ ã§ãã¾ã›ã‚“ã€‚";
          return;
        }
        errorMessage.textContent = "";  // ã‚¨ãƒ©ãƒ¼è§£é™¤
        lastColor = hex;

        const colorDiv = document.createElement('div');
        colorDiv.className = 'color-box';
        colorDiv.style.background = hex;
        colorDiv.style.color = isDarkColor(hex) ? "#ffffff" : "#000000";
        colorDiv.title = hex;
        colorDiv.textContent = hex;
        historyContainer.appendChild(colorDiv);
        // ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã«é …ç›®ãŒè¿½åŠ ã•ã‚ŒãŸã®ã§ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        downloadHistoryBtn.disabled = paletteContainer.length > 0;
      }

      // ãƒ’ã‚¹ãƒˆãƒªãƒ¼ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      downloadHistoryBtn.addEventListener('click', () => {
        // ãƒ’ã‚¹ãƒˆãƒªãƒ¼å†…ã®è‰²ãƒœãƒƒã‚¯ã‚¹ã‚’ã¾ã¨ã‚ãŸã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
        const historyItems = historyContainer.querySelectorAll('.color-box');
        if (historyItems.length === 0) {
          alert("ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã«è‰²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }
        // é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        const selectedOption = document.querySelector('input[name="history-download-option"]:checked').value;
        if (selectedOption === "include") {
          // å…ƒç”»åƒä»˜ãã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const downloadCanvas = document.createElement('canvas');
          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®é«˜ã•ã¯å…ƒç”»åƒã¨ãƒ’ã‚¹ãƒˆãƒªãƒ¼é ˜åŸŸã®é«˜ã•ã‚’åˆã‚ã›ã‚‹
          downloadCanvas.width = canvas.width;
          downloadCanvas.height = canvas.height + historyContainer.offsetHeight + 20;
          const downloadCtx = downloadCanvas.getContext('2d');

          // å…ƒç”»åƒã‚’æç”»
          downloadCtx.drawImage(img, 0, 0);

          // ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã®è‰²ãƒœãƒƒã‚¯ã‚¹ã‚’å…ƒç”»åƒã®ä¸‹ã«æç”»
          const itemSize = 40;  // å„è‰²ãƒœãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚º
          let yOffset = canvas.height + 10;
          historyItems.forEach((item, index) => {
            const col = index % 10;
            const row = Math.floor(index / 10);
            downloadCtx.fillStyle = item.title;  // title å±æ€§ã« hex å€¤ã‚’è¨­å®šã—ã¦ã„ã‚‹
            downloadCtx.fillRect(col * itemSize, yOffset + row * itemSize, itemSize, itemSize);
            // å¢ƒç•Œç·šæç”»
            downloadCtx.strokeStyle = "#000";
            downloadCtx.strokeRect(col * itemSize, yOffset + row * itemSize, itemSize, itemSize);
          });

          const dataURL = downloadCanvas.toDataURL("image/png");
          const a = document.createElement('a');
          const now = new Date().toISOString();
          a.download = `color_history_with_image_${now}.png`;
          a.href = dataURL;
          a.click();

        } else {
          // ãƒ’ã‚¹ãƒˆãƒªãƒ¼æƒ…å ±ã®ã¿ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const downloadCanvas = document.createElement('canvas');
          downloadCanvas.width = historyContainer.offsetWidth;
          downloadCanvas.height = historyContainer.offsetHeight;
          const downloadCtx = downloadCanvas.getContext('2d');

          const itemSize = 40;
          historyItems.forEach((item, index) => {
            const col = index % 10;
            const row = Math.floor(index / 10);
            downloadCtx.fillStyle = item.title;
            downloadCtx.fillRect(col * itemSize, row * itemSize, itemSize, itemSize);
          });

          const dataURL = downloadCanvas.toDataURL("image/png");
          const a = document.createElement('a');
          const now = new Date().toISOString();
          a.download = `color_history_only_${now}.png`;
          a.href = dataURL;
          a.click();
        }
      });

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã§ã€Œä¸€ç•ªä¸Šã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
      window.addEventListener('scroll', () => {
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ï¼ˆã“ã®ä¾‹ã§ã¯ç´„80pxï¼‰
        const headerHeight = 80;
        if (window.scrollY > headerHeight) {
          backToTopBtn.classList.remove('hidden');
        } else {
          backToTopBtn.classList.add('hidden');
        }
      });

      // ã€Œä¸€ç•ªä¸Šã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      downloadPaletteBtn.addEventListener('click', () => {
        const selectedOption = document.querySelector('input[name="download-option"]:checked').value;

        if (selectedOption === "include") {
          // å…ƒç”»åƒã®ä¸‹ã«ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’è¿½åŠ ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const downloadCanvas = document.createElement('canvas');
          downloadCanvas.width = canvas.width;
          downloadCanvas.height = canvas.height + paletteContainer.offsetHeight + 20;
          const downloadCtx = downloadCanvas.getContext('2d');

          // å…ƒç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
          downloadCtx.drawImage(img, 0, 0);

          // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’æç”»
          let yOffset = canvas.height + 10;
          const colorDivs = paletteContainer.querySelectorAll('.color-box');
          colorDivs.forEach((colorDiv, index) => {
            const hex = colorDiv.style.backgroundColor;
            downloadCtx.fillStyle = hex;
            downloadCtx.fillRect(index % 16 * 40, yOffset + Math.floor(index / 16) * 40, 40, 40);
          });

          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const dataURL = downloadCanvas.toDataURL('image/png');
          const a = document.createElement('a');
          const now = new Date().toISOString();
          a.download = `image_with_palette_${now}.png`;
          a.href = dataURL;
          a.click();
        } else {
          // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆæƒ…å ±ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const downloadCanvas = document.createElement('canvas');
          downloadCanvas.width = paletteContainer.offsetWidth;
          downloadCanvas.height = paletteContainer.offsetHeight;
          const downloadCtx = downloadCanvas.getContext('2d');

          // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’æç”»
          const colorDivs = paletteContainer.querySelectorAll('.color-box');
          colorDivs.forEach((colorDiv, index) => {
            const hex = colorDiv.style.backgroundColor;
            downloadCtx.fillStyle = hex;
            downloadCtx.fillRect(index % 16 * 40, Math.floor(index / 16) * 40, 40, 40);
          });

          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const dataURL = downloadCanvas.toDataURL('image/png');
          const a = document.createElement('a');
          const now = new Date().toISOString();
          a.download = `palette_only_${now}.png`;
          a.href = dataURL;
          a.click();
        }
      });
    </script>
  </body>

</html>